---
- name: "Add Artemis group"
  group:
    name: "{{ artemis_user.group }}"
    gid: "{{ artemis_group.gid }}"
    state: "present"

- name: "Add Artemis user"
  user:
    name: "{{ artemis_user.name }}"
    group: "{{ artemis_user.group }}"
    uid: "{{ artemis_user.uid }}"
    createhome: no
    state: "present"
    system: yes

- name: "Create requires directories"
  file:
    path: "{{ item }}"
    state: directory
    mode: 0755
    owner: "{{ artemis_user.name }}"
    group: "{{ artemis_user.group }}"
  with_items:
    - "{{ artemis_home }}"
    - "{{ artemis_log_dir }}"

- name: Download on Ansible host
  block:
    - name: Download archive
      get_url:
        url: "{{ artemis_download_url }}"
        dest: /tmp/
        mode: 0544
      delegate_to: localhost
      vars:
        connection: local
        run_once: true
      register: download

    - name: Exctract archive on target host
      unarchive:
        src: "{{ download.dest }}"
        dest: "{{ artemis_install_dir }}"
        remote_src: false
        owner: "{{ artemis_user.name }}"
        group: "{{ artemis_user.group }}"
        creates: "{{ artemis_home }}/bin/artemis"
      notify: restart broker

  when: not artemis_host_has_internet

- name: "Download and extract archive"
  block:
    - name: Exctract archive
      unarchive:
        src: "{{ artemis_download_url }}"
        dest: "{{ artemis_install_dir }}"
        remote_src: yes
        owner: "{{ artemis_user.name }}"
        group: "{{ artemis_user.group }}"
        creates: "{{ artemis_home }}/bin/artemis"
      notify: restart broker

  when: artemis_host_has_internet

- name: "Create link"
  file:
    src: "{{ artemis_home }}"
    dest: "{{ artemis_home_symlink }}"
    state: link
    owner: "{{ artemis_user.name }}"
    group: "{{ artemis_user.group }}"

- name: "Create brokers"
  include_tasks: instance/instance.yml
  with_items: "{{ artemis_brokers }}"
  loop_control:
    loop_var: broker
